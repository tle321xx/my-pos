<div class="container-fluid p-4">
  <h2 class="fw-bold mb-4"><i class="bi bi-people-fill"></i> จัดการบุคคล</h2>

  <ul class="nav nav-tabs mb-4">
    <li class="nav-item">
      <a class="nav-link" [class.active]="activeTab === 'staff'" (click)="activeTab = 'staff'" style="cursor: pointer;">
        <i class="bi bi-person-badge"></i> พนักงาน
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" [class.active]="activeTab === 'customer'" (click)="activeTab = 'customer'" style="cursor: pointer;">
        <i class="bi bi-person-hearts"></i> ลูกค้าสมาชิก
      </a>
    </li>
  </ul>

  <div *ngIf="activeTab === 'staff'">
    <div class="d-flex justify-content-end mb-3">
      <button class="btn btn-primary fw-bold" (click)="openModal('staff')">
        <i class="bi bi-person-plus-fill"></i> เพิ่มพนักงาน
      </button>
    </div>
    
    <div class="card border-0 shadow-sm">
      <table class="table table-hover mb-0 align-middle">
        <thead class="table-light">
          <tr><th class="ps-3">รูป</th><th>Username</th><th>ชื่อ-สกุล</th><th>ตำแหน่ง</th><th>จัดการ</th></tr>
        </thead>
        <tbody>
          <tr *ngFor="let u of pagedUsers">
            <td class="ps-3">
              <img [src]="u.image || 'assets/default-user.png'" class="avatar-sm bg-light border" onerror="this.src='https://placehold.co/40'" style="width: 40px; height: 40px; object-fit: cover; border-radius: 50%;">
            </td>
            <td class="fw-bold">{{u.username}}</td>
            <td>{{u.name}}</td>
            <td><span class="badge" [class.bg-danger]="u.role==='admin'" [class.bg-success]="u.role!=='admin'">{{u.role}}</span></td>
            <td>
              <button *ngIf="u.username !== 'admin'" class="btn btn-sm btn-outline-danger" (click)="deleteUser(u.id)"><i class="bi bi-trash"></i></button>
            </td>
          </tr>
          <tr *ngIf="pagedUsers.length === 0">
             <td colspan="5" class="text-center py-4 text-muted">ยังไม่มีข้อมูลพนักงาน</td>
          </tr>
        </tbody>
      </table>
      
      <mat-paginator [length]="allUsers.length"
                     [pageSize]="pageSize"
                     [pageIndex]="userPageIndex"
                     [pageSizeOptions]="[5, 10, 20]"
                     (page)="onUserPageChange($event)">
      </mat-paginator>
    </div>
  </div>

  <div *ngIf="activeTab === 'customer'">
    <div class="d-flex justify-content-end mb-3">
      <button class="btn btn-success fw-bold" (click)="openModal('customer')">
        <i class="bi bi-person-plus-fill"></i> เพิ่มสมาชิก
      </button>
    </div>
    
    <div class="card border-0 shadow-sm">
      <table class="table table-hover mb-0 align-middle">
        <thead class="table-light">
          <tr><th class="ps-3">รูป</th><th>ชื่อลูกค้า</th><th>เบอร์โทร</th><th>Line ID</th><th>จัดการ</th></tr>
        </thead>
        <tbody>
          <tr *ngFor="let c of pagedCustomers">
            <td class="ps-3">
              <img [src]="c.image || 'assets/default-user.png'" class="avatar-sm bg-light border" onerror="this.src='https://placehold.co/40'" style="width: 40px; height: 40px; object-fit: cover; border-radius: 50%;">
            </td>
            <td class="fw-bold">{{c.name}}</td>
            <td>{{c.phone || '-'}}</td>
            <td class="text-success">{{c.line_id || '-'}}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary" (click)="viewHistory(c)"><i class="bi bi-clock-history"></i> ประวัติ</button>
            </td>
          </tr>
          <tr *ngIf="pagedCustomers.length === 0">
             <td colspan="5" class="text-center py-4 text-muted">ยังไม่มีข้อมูลสมาชิก</td>
          </tr>
        </tbody>
      </table>

      <mat-paginator [length]="allCustomers.length"
                     [pageSize]="pageSize"
                     [pageIndex]="custPageIndex"
                     [pageSizeOptions]="[5, 10, 20]"
                     (page)="onCustPageChange($event)">
      </mat-paginator>
    </div>
  </div>

  <div class="modal fade show" tabindex="-1" *ngIf="isModalOpen" style="display: block; background: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header" [class.bg-primary]="modalType === 'staff'" [class.bg-success]="modalType === 'customer'">
          <h5 class="modal-title text-white fw-bold">
            <i class="bi" [class.bi-person-badge]="modalType === 'staff'" [class.bi-person-hearts]="modalType === 'customer'"></i>
            {{ modalType === 'staff' ? 'เพิ่มพนักงานใหม่' : 'ลงทะเบียนสมาชิก' }}
          </h5>
          <button type="button" class="btn-close btn-close-white" (click)="closeModal()"></button>
        </div>

        <div class="modal-body p-4">
          
          <div class="text-center mb-4">
            <div class="profile-upload shadow-sm" (click)="fileInput.click()">
              <img *ngIf="imagePreview" [src]="imagePreview" class="w-100 h-100 object-fit-cover">
              <div *ngIf="!imagePreview" class="text-center text-muted">
                <i class="bi bi-camera fs-3"></i><br><small>รูปโปรไฟล์</small>
              </div>
            </div>
            <input type="file" #fileInput hidden (change)="onFileSelected($event)" accept="image/*">
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">ชื่อ-นามสกุล <span class="text-danger">*</span></label>
            <input type="text" class="form-control" [(ngModel)]="formData.name" placeholder="ระบุชื่อ">
          </div>

          <ng-container *ngIf="modalType === 'staff'">
            <div class="row g-2 mb-3">
              <div class="col-6">
                <label class="form-label fw-bold">Username <span class="text-danger">*</span></label>
                <input type="text" class="form-control" [(ngModel)]="formData.username">
              </div>
              <div class="col-6">
                <label class="form-label fw-bold">Password <span class="text-danger">*</span></label>
                <input type="password" class="form-control" [(ngModel)]="formData.password">
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label fw-bold">ตำแหน่ง</label>
              <select class="form-select" [(ngModel)]="formData.role">
                <option value="staff">Staff (พนักงานขาย)</option>
                <option value="admin">Admin (ผู้จัดการ)</option>
              </select>
            </div>
          </ng-container>

          <ng-container *ngIf="modalType === 'customer'">
            <div class="row g-2 mb-3">
              <div class="col-6">
                <label class="form-label fw-bold">เบอร์โทรศัพท์</label>
                <input type="tel" class="form-control" [(ngModel)]="formData.phone">
              </div>
              <div class="col-6">
                <label class="form-label fw-bold">Line ID</label>
                <input type="text" class="form-control" [(ngModel)]="formData.line_id">
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label fw-bold">เลขบัตรประชาชน (Optional)</label>
              <input type="text" class="form-control" [(ngModel)]="formData.id_card" placeholder="สำหรับออกใบกำกับภาษี">
            </div>
          </ng-container>

        </div>

        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-secondary" (click)="closeModal()">ยกเลิก</button>
          <button type="button" class="btn fw-bold text-white px-4" 
                  [class.btn-primary]="modalType === 'staff'" 
                  [class.btn-success]="modalType === 'customer'"
                  (click)="submitForm()">
            <i class="bi bi-save me-1"></i> บันทึกข้อมูล
          </button>
        </div>
      </div>
    </div>
  </div>
</div>